<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  {% load staticfiles %}
  
  <title>Market Dashboard</title>
  <link rel="stylesheet" href="../static/css/bitcoin.css" />
  <link rel="stylesheet" href="../static/bootstrap/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../static/bootstrap/css/bootstrap-theme.css" />
  <link rel='stylesheet' href='../static/css/spectrum.css' />
  
  <script src="http://codeorigin.jquery.com/jquery-2.0.3.min.js"></script>  
  <script src="http://localhost/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="../static/js/masonry.pkgd.min.js"></script>
  <script type="text/javascript" src="../static/bootstrap/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="../static/js/handlebars.js"></script>
  <script type="text/javascript" src="../static/js/underscore-min.js"></script>
  <script type="text/javascript" src='../static/js/spectrum.js'></script>
  <script type="text/javascript" src="../static/js/highstock.js"></script>
  <script type="text/javascript" src="../static/js/exporting.js"></script>
  
<script type="text/javascript">
docReady( function() {
	  var container = document.querySelector('#basic');
	  var msnry = new Masonry( container, {
		  columnWidth: 5,
		  itemSelector: '.item'
	  });
	});
	
$(function() {
	var jsonUrl = "{% static data.json%}"

	//$.getJSON(jsonUrl+'data.json', function(data) {
	$.getJSON('/ohlc/', function(data) {
		//console.log(data);
		var json = JSON.parse(data);
		//console.log(json);
		// split the data set into ohlc and volume
		var ohlc = [],
			volume = [],
			ma7 = [],
			ma14 = [],
			dataLength = data.length;
			
		for (i = 0; i < dataLength; i++) {
			if (_.isUndefined(json[i])){
				break;
			}
			console.log(json[i])
					
			ohlc.push([
				json[i].time, // the date
				json[i].open, // open
				json[i].high, // high
				json[i].low, // low
				json[i].close // close
			]);			
			
		}

		// set the allowed units for data grouping
		var groupingUnits = [[
			'day',                         // unit name:day,week
			[1]                             // allowed multiples
		], [
			'month',
			[1, 2, 3, 4, 6]
		]];

		// create the chart
		$('#chart').highcharts('StockChart', {
			chart:{
				backgroundColor:'#FCFFC5'
			},
			tooltip: {
		    	valueDecimals: 2,		    	
		    },
			navigator: {
				enabled: false
			},
			
			scrollbar: {
				enabled: false
			},
		    
		    rangeSelector: {
		    	buttons: [{
		            type: 'minute',
		            count: 1,
		            text: '1min'
		        }, {
		            type: 'day',
		            count: 1,
		            text: '3d'
		        }, {
		            type: 'week',
		            count: 1,
		            text: '1w'
		        }, {
		            type: 'month',
		            count: 1,
		            text: '1m'
		        }, {
		            type: 'month',
		            count: 6,
		            text: '6m'
		        }, {
		            type: 'year',
		            count: 1,
		            text: '1y'
		        }, {
		            type: 'all',
		            text: 'All'
		        }],
		        selected: 1
		    },

		    title: {
		        text: 'Bitcoin Graph'
		    },

		    yAxis: [{
		        title: {
		            text: 'Price'
		        },
		        height: 200,
		        lineWidth: 2
		    }, {
		        title: {
		            text: 'Volume'
		        },
		        top: 300,
		        height: 100,
		        offset: 0,
		        lineWidth: 2
		    },{		  
				title: {
					text: 'MACD'
				},
		        top: 400,			
		        height: 50,
		        offset: 0,
		        lineWidth: 2
		    }],
		    
		    series: [{
		        type: 'candlestick',
		        name: 'AAPL',
		        data: ohlc,
		        dataGrouping: {
					units: groupingUnits
		        }
		    }, {
		        type: 'column',
		        name: 'Volume',
		        data: volume,
		        yAxis: 1,
		        dataGrouping: {
					units: groupingUnits
		        }
		    }, {
		        type: 'line',
		        name: 'MA7',
		        data: ma7,
		        dataGrouping: {
					units: groupingUnits
		        }
		    }, {
		        type: 'line',
		        name: 'DEA',
		        data: ma7,
		        yAxis: 2,
		        dataGrouping: {
					units: groupingUnits
		        }
		    }, {
		        type: 'line',
		        name: 'DIF',
		        data: ma14,
		        yAxis: 2,
		        dataGrouping: {
					units: groupingUnits
		        }
		    }]
		});
	});
	
	$('.dropdown-toggle').dropdown();
	$('.dropdown input, .dropdown label').click(function(e) {
	    e.stopPropagation();
	  });
	
	
	//show/hide MA indicator
	$('#showMa').click(function(){
		var chart = $('#chart').highcharts(),
        	series = chart.series[2];
		if (series.visible) {			
		} else {
			series.show();
		}		
	})
	
	$('#hideMa').click(function(){
		var chart = $('#chart').highcharts(),
        	series = chart.series[2];
		if (series.visible) {
			series.hide();
		}		
	})
	
	$("#chartBackColor").spectrum({
		preferredFormat: "hex",
		showInput: true,
		change: function(color) {
	    	var chart = $('#chart').highcharts();
	    	console.log(chart.options.chart.backgroundColor);
	    	//console.log(color.toHexString());
	    	chart.chartBackground.css({
                color: color.toHexString(),
                fontSize: '16px'
            });
	    },
	});
	
	//var audio = $('#audio');
	//audio.get(0).play();
	//audio.trigger('play'); also works!
	//http://www.uscis.gov/files/nativedocuments/Track%2093.mp3
	//../static/Kalimba.mp3
    var audioElement = document.createElement('audio');
    audioElement.setAttribute('src', 'http://www.uscis.gov/files/nativedocuments/Track%2093.mp3');
    //audioElement.setAttribute('autoplay', 'autoplay'); must enable autoplay to play immediately!
    //audioElement.load()
    $.get();
    audioElement.addEventListener("load", function() {
    audioElement.play();
    }, true);




    $('.play').click(function() {
    audioElement.play();
    });


    $('.pause').click(function() {
    audioElement.pause();
    });
    
    var socket = io.connect('http://localhost:80');
    socket.on('news', function (data) {
      console.log("new received*****************");
      console.log(data);
      //console.log(_.isObject(data));
      
      if (!_.isObject(data) && typeof data.replace === 'function'){
    	  //replace ' with "          
	      //var b = data.replace(/'/g, '"');
	      //console.log(b);
	      //jQuery.parseJSON('{"name":"John"}');
	      var livePrice = JSON.parse(data);
	      console.log(livePrice);
	      //console.log(obj.sell);
	      console.log({{alert.high}});
	      console.log({{alert.low}});
	      if (livePrice.last>={{alert.high}} || livePrice.last<={{alert.low}}){
	    	  console.log('raise alert**************');
	    	  //trigger sound
	    	  var audio = $('#audio');
	    	  //audio.get(0).play(); also works
	    	  audio.trigger('play');
	      }
	      var source   = $("#live_price").html();
	      //console.log(source);
	      var template = Handlebars.compile(source);
	      //var context = {current: "11111"}
	      var html    = template(livePrice);
	      console.log(html);
	  	  $('#summary').html(html);	  	
    }      
      //socket.emit('my other event', { my: 'data' });
  	  }); 
    
    socket.on('trades', function (data) {
    	console.log("trades received*****************");
        //console.log(data);
        //console.log(_.isObject(data));
        
        if (!_.isObject(data) && typeof data.replace === 'function'){
      	  //replace ' with "          
  	      //var b = data.replace(/'/g, '"');
  	      //console.log(b);
  	      //jQuery.parseJSON('{"name":"John"}');
  	      var liveTrades = JSON.parse(data);
  	      //console.log(liveTrades);
  	      //console.log(obj.sell);
  	      var source   = $("#live_trades").html();
  	      //console.log(source);
  	      var template = Handlebars.compile(source);
  	      //var context = {current: "11111"}
  	      var html    = template(liveTrades);
  	      //console.log(html);
  	  	  $('#trades').html(html);
      }             
    }); 
    
    socket.on('asks', function (data) {
    	console.log("asks received*****************");
        //console.log(data);
        //console.log(_.isObject(data));
        
        if (!_.isObject(data) && typeof data.replace === 'function'){
      	  //replace ' with "          
  	      //var b = data.replace(/'/g, '"');
  	      //console.log(b);
  	      //jQuery.parseJSON('{"name":"John"}');
  	      var liveAsks = JSON.parse(data);
  	      //console.log(liveAsks);
  	      //console.log(obj.sell);
  	      var source   = $("#asksTemplate").html();
  	      //console.log(source);
  	      var template = Handlebars.compile(source);
  	      //var context = {current: "11111"}
  	      var html    = template(liveAsks);
  	      //console.log(html);
  	  	  $('#asks').html(html);
      }             
    }); 
    
    
    socket.on('bids', function (data) {
    	console.log("bids received*****************");
        //console.log(data);
        //console.log(_.isObject(data));
        
        if (!_.isObject(data) && typeof data.replace === 'function'){
      	  //replace ' with "          
  	      //var b = data.replace(/'/g, '"');
  	      //console.log(b);
  	      //jQuery.parseJSON('{"name":"John"}');
  	      var liveBids = JSON.parse(data);
  	      //console.log(liveBids);
  	      //console.log(obj.sell);
  	      var source   = $("#bidsTemplate").html();
  	      //console.log(source);
  	      var template = Handlebars.compile(source);
  	      //var context = {current: "11111"}
  	      var html    = template(liveBids);
  	      //console.log(html);
  	  	  $('#bids').html(html);
      }             
    }); 
    
    
    //console.log({{alert.high}});
    $('#high').val({{alert.high}});
    $('#low').val({{alert.low}});
    $('#alertButton').click(function() {
    	$.post("/update_alert/", { high: $('#high').val(),low: $('#low').val() });
    });
});
</script>
<script id="live_price" type="text/x-handlebars-template">
{% verbatim %}
  最新价：{{last}}&nbsp;&nbsp;&nbsp;&nbsp;最高价：{{high}} 最低价：{{low}}  成交量：{{vol}}
{% endverbatim %}
</script>
<script id="live_trades" type="text/x-handlebars-template">
{% verbatim %}
  <table id="trades" class="table">
    <thead>
      <th>时间</th>
      <th>价格</th>
      <th>类型</th>
	  <th>数量</th>
    </thead>
    <tbody>
      {{#each []}}
        <tr>
          <td>{{this.time}}</td>
          <td>{{this.price}}</td>
          <td>{{this.type}}</td>
		  <td>{{this.amount}}</td>
        </tr>
      {{/each}}
    </tbody>
  </table>
{% endverbatim %}
</script>
<script id="asksTemplate" type="text/x-handlebars-template">
{% verbatim %}
  <table id="asks" class="table">
    <thead>
      <th>卖出价格</th>
      <th>数量</th>
      <th>累积量</th>	  
    </thead>
    <tbody>
      {{#each []}}
        <tr>
		{{#each []}}
          <td>{{this}}</td>
		{{/each}}          		  
        </tr>
      {{/each}}
    </tbody>
  </table>
{% endverbatim %}
</script>
<script id="bidsTemplate" type="text/x-handlebars-template">
{% verbatim %}
  <table id="bids" class="table">
    <thead>
      <th>买入价格</th>
      <th>数量</th>
      <th>累积量</th>	  
    </thead>
    <tbody>
      {{#each []}}
        <tr>
		{{#each []}}
          <td>{{this}}</td>
		{{/each}}          		  
        </tr>
      {{/each}}
    </tbody>
  </table>
{% endverbatim %}
</script>
</head>
<body>
  <div id="basic" class="container2">
  {% verbatim %}
  	<div id="summary" class="item w4 h2">  				
  	</div>
  	{% endverbatim %}
  	<div class="item w4 h3">  	
	  	<ul class="nav nav-pills">
	  	  <p class="navbar-text">Time Period:</p>
		  <li><a href="#">1w</a></li>
		  <li><a href="#">1d</a></li>
		  <li><a href="#">6h</a></li>
		  <li><a href="#">15m</a></li>
		  <li><a href="#">1m</a></li>
		  <li class="dropdown">
            <a class="dropdown-toggle" href="#" data-toggle="dropdown">Settings <strong class="caret"></strong></a>
            <div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
              Main Indicator:
              <button id="showMa" type="button" class="btn btn-primary" data-toggle="button">MA</button>
              <button id="hideMa" type="button" class="btn btn-primary" data-toggle="button">None</button><br>
              Technical Indicator:
              <button type="button" class="btn btn-primary" data-toggle="button">MACD</button>
              <button type="button" class="btn btn-primary" data-toggle="button">KDJ</button>
              <button type="button" class="btn btn-primary" data-toggle="button">None</button><br>
              <label>Chart Background Color:</label>
              <input type='text' id="chartBackColor"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>              
            </div>
          </li>
          <li class="dropdown">
            <a class="dropdown-toggle" href="#" data-toggle="dropdown">Parameters <strong class="caret"></strong></a>
            <div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
              MA:
               <input type='text' id="ma1"/>
               <input type='text' id="ma2"/>
               <input type='text' id="ma3"/>
               <input type='text' id="ma4"/>
              <button id="showMa" type="button" class="btn btn-primary" data-toggle="button">Default</button><br>
              MACD:
               <input type='text' id="ma1"/>
               <input type='text' id="ma2"/>
               <input type='text' id="ma3"/>               
              <button id="showMa" type="button" class="btn btn-primary" data-toggle="button">Default</button><br>
              KDJ:
               <input type='text' id="ma1"/>
               <input type='text' id="ma2"/>
               <input type='text' id="ma3"/>               
              <button id="showMa" type="button" class="btn btn-primary" data-toggle="button">Default</button><br>                           
            </div>
          </li>
		  <li class="dropdown">
            <a class="dropdown-toggle" href="#" data-toggle="dropdown">Alerts <strong class="caret"></strong></a>
            <div class="dropdown-menu w6" style="padding: 15px; padding-bottom: 0px;">
              High Price:
              <input id="high" style="margin-bottom: 15px;" type="text" size="30"/><br>
              Low Price:
              <input id="low" style="margin-bottom: 15px;" type="text" size="30"/>
              <button id="alertButton" type="button" class="btn btn-primary" data-toggle="button">Submit</button>             
			</div>
          </li>
		</ul>
  	</div>
  	
    <div id="chart" class="item w5 h6">Chart</div>
    
    <div id="asks" class="item w2 h7 autoscroll">卖单</div>    
    
	<div id="bids" class="item w2 h7 autoscroll">买单</div>	
	
    <div id="trades" class="item w6 h7 autoscroll">最新成交记录</div>


   	<audio id="audio" >
        <source src="../static/alert.mp3" type="audio/mpeg"></source>
			Your browser does not support the audio element.
	</audio>
</div>


</body>
</html>
